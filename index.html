<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Speed Chat Timers</title>
    <style>
        body {
            font-family: sans-serif;
            background: #fafafa;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            color: #4a4949;
        }

        .timer {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 200px;
            margin: 1rem;
            padding: 1rem;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 2px solid #ff97d7;
            height: 120px;
            vertical-align: top;
        }

        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 1rem;
        }

        .people-panel {
            width: 200px;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 2px solid #ff97d7;
            min-height: 60px;
        }

        .people-panel .title {
            font-size: 0.9rem;
            color: #8f0057;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .people-panel .seats-info {
            font-size: 0.8rem;
            color: #8f0057;
            margin-bottom: 0.5rem;
        }

        .people-panel .people-list {
            font-size: 0.9rem;
            color: #4a4949;
            line-height: 1.4;
        }

        .people-panel .empty-message {
            font-size: 0.9rem;
            color: #999;
            font-style: italic;
        }

        .timer.active {
            border: 2px solid #8f0057;
        }

        .timer.inactive {
            opacity: 0.6;
        }

        .timer.finish-window {
            background: #8f0057 !important;
            color: #fff !important;
            border-color: #fff !important;
        }

        .timer.finish-window .label {
            color: #ff97d7 !important;
        }

        .timer .label {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: #8f0057;
            height: 1.5rem;
        }

        .timer .count {
            font-size: 2.7rem;
            font-weight: bold;
            color: #4a4949;
            height: 2.5rem;
            line-height: 2.5rem;
            margin-top: 0.5rem;
        }

        .timer .count.starting-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            line-height: 1.2;
            white-space: normal;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: auto;
            min-height: 2.5rem;
        }

        .timer .count.starting-text .scheduled-time {
            font-size: 1.1rem;
            color: #666;
            margin-top: 0.2rem;
        }

        .timer .count.lounge-text {
            font-size: 1.3rem;
            font-weight: bold;
            color: #fff;
        }

        .config-section {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
        }

        .config-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            cursor: pointer;
            padding: 0;
            margin-bottom: 1rem;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .config-content {
            display: none;
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            width: 300px;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
            border: 2px solid #ff97d7;
            position: absolute;
            top: 100%;
            right: 0;
            z-index: 1001;
        }

        .config-content.visible {
            display: block;
            overflow: visible;
        }

        .config-header.open {
            background: #ff97d7;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .gear-icon {
            width: 36px;
            height: 36px;
            cursor: pointer;
            transition: transform 0.3s ease;
            stroke: #4a4949;
        }

        .config-header.open .gear-icon {
            stroke: #8f0057;
        }

        .gear-icon:hover {
            transform: rotate(45deg);
        }

        .global-settings {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #fff;
            border-radius: 4px;
            border: 1px solid #ff97d7;
        }

        .global-settings label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #8f0057;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tooltip-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff97d7;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: help;
            position: relative;
        }

        .tooltip-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: calc(100% + 5px);
            padding: 8px 12px;
            background: #8f0057;
            color: white;
            border-radius: 4px;
            font-size: 14px;
            font-weight: normal;
            white-space: nowrap;
            z-index: 2002;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .tooltip-icon:hover::before {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: calc(100% - 5px);
            border-width: 5px;
            border-style: solid;
            border-color: #8f0057 transparent transparent transparent;
        }

        .global-settings select {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #ff97d7;
            border-radius: 4px;
            color: #4a4949;
        }

        .line-config {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #fff;
            border-radius: 4px;
            align-items: center;
            border: 1px solid #ff97d7;
        }

        .line-fields {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.5rem;
            width: 100%;
        }

        .line-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            width: 100%;
        }

        .line-buttons button {
            background: #8f0057;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .line-buttons button:hover {
            background: #ff97d7;
            color: #fff;
        }

        .line-buttons button:last-child {
            background: #4a4949;
        }

        .line-buttons button:last-child:hover {
            background: #666;
        }

        .line-config input[type="text"] {
            padding: 0.5rem;
            border: 1px solid #ff97d7;
            border-radius: 4px;
            width: 100%;
            color: #4a4949;
        }

        .line-config select {
            padding: 0.5rem;
            border: 1px solid #ff97d7;
            border-radius: 4px;
            min-width: 80px;
            color: #4a4949;
        }

        .add-line-btn {
            background: #8f0057;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 1rem;
            width: 100%;
        }

        .start-btn {
            background: #8f0057;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
        }

        .start-btn:hover,
        .add-line-btn:hover {
            background: #ff97d7;
        }

        .reset-btn {
            background: #4a4949;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
        }

        .reset-btn:hover {
            background: #666;
        }

        .line-config button:hover {
            background: #ff97d7;
        }

        h1 {
            color: #8f0057;
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2.5rem;
        }

        .logo-container {
            width: 180px;
            height: 180px;
            margin: 0 auto 2rem;
            background: #ff97d7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #8f0057;
        }

        .logo {
            width: 70%;
            height: 70%;
            object-fit: contain;
        }

        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(143, 0, 87, 0.95);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            z-index: 2000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: fadeInOut 8s ease-in-out;
        }

        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            display: none;
            animation: fadeInOut 8s ease-in-out;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            80% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        #timers-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2rem;
            margin: 0 -1rem;
        }

        @media (max-width: 1200px) {
            body {
                padding: 1rem;
                font-size: 20px;
            }

            #timers-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 2rem;
                margin: 0;
                padding: 0.5rem;
            }

            .timer {
                width: 100%;
                max-width: 400px;
                margin: 0;
                height: 220px;
                padding: 2.5rem;
                border-width: 4px;
            }

            .timer .label {
                font-size: 2.2rem;
                margin-bottom: 2rem;
                height: 2.5rem;
            }

            .timer .count {
                font-size: 5rem;
                height: 5.5rem;
                line-height: 5.5rem;
            }

            .logo-container {
                width: 240px;
                height: 240px;
                margin: 0 auto 2.5rem;
            }

            h1 {
                font-size: 3rem;
                margin-bottom: 2.5rem;
            }

            .gear-icon {
                width: 48px;
                height: 48px;
                stroke-width: 3;
            }

            .notification {
                width: 95%;
                max-width: 500px;
                padding: 2.5rem;
                font-size: 2.5rem;
            }
        }

        @media (max-width: 600px) {
            .gear-icon {
                width: 64px;
                height: 64px;
                stroke-width: 3.5;
            }

            .config-section {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                z-index: 2000;
                display: flex;
                flex-direction: column;
                align-items: flex-end;
            }

            .config-content {
                width: 100%;
                height: 100%;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0;
                box-shadow: none;
                padding: 2.5rem 1rem 1rem 1rem;
                box-sizing: border-box;
                z-index: 2001;
                display: block;
            }
        }

        @media (max-width: 900px) {
            .config-section {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                z-index: 2000;
                background: rgba(0, 0, 0, 0.5);
            }

            .config-content {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0;
                box-shadow: none;
                top: 0;
                left: 0;
                right: 0;
                padding: 2.5rem 1rem 1rem 1rem;
                box-sizing: border-box;
                z-index: 2001;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .config-header {
                position: fixed;
                top: 1rem;
                right: 1rem;
                z-index: 2002;
            }

            .timer {
                width: 100%;
                max-width: 400px;
                margin: 0;
                height: 220px;
                padding: 2.5rem;
                border-width: 4px;
                border-radius: 12px;
            }

            .timer .label {
                font-size: 2.5rem;
                margin-bottom: 2rem;
                height: 2.5rem;
            }

            .timer .count {
                font-size: 5rem;
                height: 5.5rem;
                line-height: 5.5rem;
            }

            .logo-container {
                border-width: 4px;
                border-color: #8f0057;
            }
        }

        #scheduleForm {
            position: relative;
            padding-bottom: 120px;
            /* Space for the sticky buttons */
        }

        .form-buttons {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            padding: 1rem 0;
            margin-top: 1rem;
            border-top: 2px solid #ff97d7;
            z-index: 1002;
        }

        .start-btn {
            background: #8f0057;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .reset-btn {
            background: #4a4949;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        @media (max-width: 900px) {
            .form-buttons {
                padding: 1rem;
                background: #fff;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }
        }

        .line-config {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #fff;
            border-radius: 4px;
            align-items: center;
            border: 1px solid #ff97d7;
        }

        .people-management {
            width: 100%;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #fafafa;
            border-radius: 4px;
            border: 1px solid #ff97d7;
        }

        .people-count {
            font-weight: bold;
            color: #8f0057;
            margin-bottom: 0.5rem;
        }

        .people-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .person-entry {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #fff;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #ff97d7;
        }

        .person-entry button {
            background: none;
            border: none;
            color: #8f0057;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 0.25rem;
            line-height: 1;
        }

        .person-entry button:hover {
            color: #ff97d7;
        }

        .add-person {
            display: flex;
            gap: 0.5rem;
        }

        .add-person input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ff97d7;
            border-radius: 4px;
        }

        .add-person button {
            background: #8f0057;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .add-person button:hover {
            background: #ff97d7;
        }

        .timer .people {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #4a4949;
            max-height: 3em;
            overflow-y: auto;
        }

        .timer .people-count {
            font-size: 0.8rem;
            color: #8f0057;
            margin-top: 0.25rem;
        }

        .timer.blinking {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% {
                background: #fff;
                color: #4a4949;
            }

            50% {
                background: #8f0057;
                color: #fff;
            }

            100% {
                background: #fff;
                color: #4a4949;
            }
        }

        .timer.blinking .label {
            color: inherit;
        }

        .timer.blinking .count {
            color: inherit;
        }

        .role-selector {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #ff97d7;
        }

        .role-selector select {
            padding: 0.5rem;
            border: 1px solid #ff97d7;
            border-radius: 4px;
            color: #4a4949;
            width: 100%;
        }

        .role-selector label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #8f0057;
        }

        /* Password Modal Styles */
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .password-modal.visible {
            display: flex;
        }

        .password-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 2px solid #ff97d7;
        }

        .password-modal h2 {
            color: #8f0057;
            margin-bottom: 1rem;
        }

        .password-modal input {
            width: 100%;
            padding: 0.75rem;
            margin: 1rem 0;
            border: 1px solid #ff97d7;
            border-radius: 4px;
            font-size: 1rem;
        }

        .password-modal button {
            background: #8f0057;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
        }

        .password-modal button:hover {
            background: #ff97d7;
        }

        .password-error {
            color: #ff0000;
            margin-top: 0.5rem;
            display: none;
        }
    </style>
</head>

<body>
    <!-- Password Modal -->
    <div class="password-modal" id="passwordModal">
        <div class="password-modal-content">
            <h2>Enter Password</h2>
            <input type="password" id="passwordInput" placeholder="Enter password">
            <div class="password-error" id="passwordError">Incorrect password</div>
            <button onclick="checkPassword()">Submit</button>
        </div>
    </div>

    <div class="role-selector">
        <label>Select Role:</label>
        <select id="userRole" onchange="updateUIBasedOnRole()">
            <option value="admin">Admin</option>
            <option value="dispatcher">Dispatcher</option>
            <option value="viewer">Viewer</option>
        </select>
    </div>

    <div class="logo-container">
        <img src="logo.png" alt="Speed Chat Logo" class="logo">
    </div>
    <h1>Welcome to Speed Chat!</h1>

    <div class="notification-overlay" id="notificationOverlay"></div>
    <div class="notification" id="changeSeatNotification">
        Change seat, go to the left
    </div>

    <div class="config-section">
        <div class="config-header" onclick="toggleConfig()">
            <svg class="gear-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" />
                <path
                    d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" />
            </svg>
        </div>
        <div class="config-content" id="configContent">
            <div class="global-settings">
                <label>
                    Session Duration
                    <span class="tooltip-icon" data-tooltip="How long each speed chat session will last">?</span>
                </label>
                <select id="sessionDuration">
                    <option value="10">10 minutes</option>
                    <option value="15">15 minutes</option>
                    <option value="20">20 minutes</option>
                    <option value="25">25 minutes</option>
                    <option value="30" selected>30 minutes</option>
                    <option value="35">35 minutes</option>
                    <option value="40">40 minutes</option>
                    <option value="45">45 minutes</option>
                    <option value="50">50 minutes</option>
                    <option value="55">55 minutes</option>
                    <option value="60">60 minutes</option>
                </select>

                <label>
                    Alarm Interval
                    <span class="tooltip-icon"
                        data-tooltip="How often the alarm will sound to remind people to change seats">?</span>
                </label>
                <select id="alarmInterval">
                    <option value="1">1 minute</option>
                    <option value="2">2 minutes</option>
                    <option value="3">3 minutes</option>
                    <option value="4">4 minutes</option>
                    <option value="5" selected>5 minutes</option>
                    <option value="6">6 minutes</option>
                    <option value="7">7 minutes</option>
                    <option value="8">8 minutes</option>
                    <option value="9">9 minutes</option>
                    <option value="10">10 minutes</option>
                </select>

                <label>
                    Finish Window
                    <span class="tooltip-icon"
                        data-tooltip="How many minutes before the end when people should start moving to the lobby">?</span>
                </label>
                <select id="finishWindow">
                    <option value="1">1 minute</option>
                    <option value="2">2 minutes</option>
                    <option value="3">3 minutes</option>
                    <option value="4">4 minutes</option>
                    <option value="5" selected>5 minutes</option>
                    <option value="6">6 minutes</option>
                    <option value="7">7 minutes</option>
                    <option value="8">8 minutes</option>
                    <option value="9">9 minutes</option>
                    <option value="10">10 minutes</option>
                </select>

                <label>
                    Maximum People per Line
                    <span class="tooltip-icon"
                        data-tooltip="Maximum number of people that can be registered in each line">?</span>
                </label>
                <select id="maxPeople">
                    <option value="4">4 people</option>
                    <option value="6">6 people</option>
                    <option value="8">8 people</option>
                    <option value="10">10 people</option>
                    <option value="12">12 people</option>
                    <option value="14">14 people</option>
                    <option value="16">16 people</option>
                    <option value="18">18 people</option>
                    <option value="20">20 people</option>
                </select>

                <label>
                    Blink Before Start
                    <span class="tooltip-icon"
                        data-tooltip="How many minutes before start time the timer will start blinking">?</span>
                </label>
                <select id="blinkTime">
                    <option value="1">1 minute</option>
                    <option value="2">2 minutes</option>
                    <option value="3">3 minutes</option>
                    <option value="4">4 minutes</option>
                    <option value="5" selected>5 minutes</option>
                    <option value="6">6 minutes</option>
                    <option value="7">7 minutes</option>
                    <option value="8">8 minutes</option>
                    <option value="9">9 minutes</option>
                    <option value="10">10 minutes</option>
                </select>
            </div>

            <button class="add-line-btn" onclick="addLineConfig()">Add Line</button>
            <form id="scheduleForm">
                <div id="linesContainer">
                    <!-- Line configurations will be added here -->
                </div>
                <div class="form-buttons">
                    <button type="submit" class="start-btn">Start Timers</button>
                    <button type="button" class="reset-btn" onclick="resetApplication()">Reset All Settings</button>
                </div>
            </form>
        </div>
    </div>

    <div id="timers-container">
        <!-- Timers will be added here -->
    </div>

    <audio id="bell" src="alarm.mp3" preload="auto"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Initialize variables first
        let MS5 = 5 * 60 * 1000;
        const bell = document.getElementById('bell');
        let scheduledTimes = {};
        let lineConfigs = [];
        let TOTAL_SESSION_TIME = 30 * 60 * 1000;
        let FINISH_WINDOW_MIN = 5;
        let MAX_PEOPLE_PER_LINE = 4;
        let BLINK_TIME_MIN = 5;
        let currentRole = 'admin';
        let isUpdatingUI = false;
        let alarmDuration = 0;
        let audioEnabled = false;

        // Enable audio on first user interaction
        document.addEventListener('click', function enableAudio() {
            if (!audioEnabled) {
                audioEnabled = true;
                // Try to play and immediately pause to enable audio
                bell.play().then(() => {
                    bell.pause();
                    bell.currentTime = 0;
                    console.log('Audio enabled successfully');
                }).catch(error => {
                    console.error('Error enabling audio:', error);
                });
                // Remove the event listener after first interaction
                document.removeEventListener('click', enableAudio);
            }
        }, { once: true });

        // Get the duration of the alarm sound and ensure it's loaded
        bell.addEventListener('loadeddata', function () {
            console.log('Alarm sound loaded successfully');
            alarmDuration = bell.duration * 1000; // Convert to milliseconds
        });

        bell.addEventListener('error', function (e) {
            console.error('Error loading alarm sound:', e);
        });

        // Connect to WebSocket server
        const socket = io('http://localhost:5001', {
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });

        // Add connection status logging
        socket.on('connect', () => {
            console.log('Connected to WebSocket server');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from WebSocket server');
        });

        socket.on('connect_error', (error) => {
            console.error('WebSocket connection error:', error);
        });

        // Listen for state updates from the server
        socket.on('state_update', (newState) => {
            console.log('Received state update:', newState);

            // Ensure we have a valid state structure
            if (!newState || !newState.config) {
                console.error('Invalid state received:', newState);
                return;
            }

            // Update global variables
            TOTAL_SESSION_TIME = parseInt(newState.config.sessionDuration) * 60 * 1000;
            MS5 = parseInt(newState.config.alarmInterval) * 60 * 1000;
            MAX_PEOPLE_PER_LINE = parseInt(newState.config.maxPeoplePerLine);
            BLINK_TIME_MIN = parseInt(newState.config.blinkTime || "5");
            FINISH_WINDOW_MIN = parseInt(newState.config.finishWindow || "5");

            // Update lineConfigs and scheduledTimes
            lineConfigs = newState.config.lines.map((line, index) => ({
                id: index + 1,
                name: line.name,
                time: line.time || '',
                people: line.people || []
            }));

            // Update scheduledTimes based on lineConfigs
            lineConfigs.forEach(config => {
                if (config.time) {
                    scheduledTimes[config.id] = parseTime(config.time);
                }
            });

            // Update UI elements
            updateUIFromState(newState.config);
            // Force timer update
            updateTimers();
        });

        // Function to update UI from state
        function updateUIFromState(config) {
            console.log('Updating UI from state:', config);

            // Update form elements
            const elements = {
                "sessionDuration": config.sessionDuration,
                "alarmInterval": config.alarmInterval,
                "maxPeoplePerLine": config.maxPeoplePerLine,
                "blinkBeforeStart": config.blinkBeforeStart,
                "blinkTime": config.blinkTime,
                "finishWindow": config.finishWindow
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    if (typeof value === 'boolean') {
                        element.checked = value;
                    } else {
                        element.value = value;
                    }
                }
            });

            // Update lines
            const linesContainer = document.getElementById("linesContainer");
            if (linesContainer) {
                linesContainer.innerHTML = "";
                lineConfigs.forEach(config => {
                    const lineDiv = document.createElement("div");
                    lineDiv.className = "line-config";
                    lineDiv.innerHTML = `
                        <div class="line-fields">
                            <input type="text" 
                                   class="line-name"
                                   value="${config.name}" 
                                   onchange="updateLineName(${config.id}, this.value)"
                                   placeholder="Line name"
                                   ${currentRole !== 'admin' ? 'disabled' : ''}>
                            <select id="time${config.id}" required ${currentRole !== 'admin' ? 'disabled' : ''}>
                                ${generateTimeOptions().map(time =>
                        `<option value="${time}" ${config.time === time ? 'selected' : ''}>${time}</option>`
                    ).join('')}
                            </select>
                        </div>
                        <div class="people-management">
                            <div class="people-count">
                                People: ${config.people ? config.people.length : 0}/${MAX_PEOPLE_PER_LINE}
                            </div>
                            <div class="people-list">
                                ${(config.people || []).map(person => `
                                    <div class="person-entry">
                                        <span>${person.name}</span>
                                        ${currentRole !== 'viewer' ? `
                                            <button type="button" onclick="removePerson(${config.id}, ${person.id})">×</button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            ${currentRole !== 'viewer' ? `
                                <div class="add-person">
                                    <input type="text" 
                                           id="newPerson${config.id}" 
                                           placeholder="Add person's name"
                                           onkeypress="handlePersonInput(event, ${config.id})">
                                    <button type="button" onclick="addPerson(${config.id})">Add</button>
                                </div>
                            ` : ''}
                        </div>
                        ${currentRole === 'admin' ? `
                            <div class="line-buttons">
                                <button type="button" onclick="updateLineTime(${config.id})">Update</button>
                                <button type="button" onclick="removeLineConfig(${config.id})">Remove</button>
                            </div>
                        ` : ''}
                    `;
                    linesContainer.appendChild(lineDiv);
                });
            }
        }

        function toggleConfig() {
            const content = document.getElementById('configContent');
            const header = document.querySelector('.config-header');
            content.classList.toggle('visible');
            header.classList.toggle('open');
        }

        function addLineConfig() {
            const lineId = lineConfigs.length + 1;
            const lineConfig = {
                id: lineId,
                name: `Line ${lineId}`,
                time: '',
                people: []
            };
            lineConfigs.push(lineConfig);
            updateLineConfigs();
            saveState();
        }

        function removeLineConfig(lineId) {
            lineConfigs = lineConfigs.filter(config => config.id !== lineId);
            updateLineConfigs();
            saveState();
        }

        function updateLineConfigs() {
            const container = document.getElementById('linesContainer');
            container.innerHTML = lineConfigs.map(config => `
                <div class="line-config">
                    <div class="line-fields">
                        <input type="text" 
                               value="${config.name}" 
                               onchange="updateLineName(${config.id}, this.value)"
                               placeholder="Line name"
                               ${currentRole !== 'admin' ? 'disabled' : ''}>
                        <select id="time${config.id}" required ${currentRole !== 'admin' ? 'disabled' : ''}>
                            ${generateTimeOptions().map(time =>
                `<option value="${time}" ${config.time === time ? 'selected' : ''}>${time}</option>`
            ).join('')}
                        </select>
                    </div>
                    <div class="people-management">
                        <div class="people-count">
                            People: ${config.people ? config.people.length : 0}/${MAX_PEOPLE_PER_LINE}
                        </div>
                        <div class="people-list">
                            ${(config.people || []).map(person => `
                                <div class="person-entry">
                                    <span>${person.name}</span>
                                    ${currentRole !== 'viewer' ? `
                                        <button type="button" onclick="removePerson(${config.id}, ${person.id})">×</button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        ${currentRole !== 'viewer' ? `
                            <div class="add-person">
                                <input type="text" 
                                       id="newPerson${config.id}" 
                                       placeholder="Add person's name"
                                       onkeypress="handlePersonInput(event, ${config.id})">
                                <button type="button" onclick="addPerson(${config.id})">Add</button>
                            </div>
                        ` : ''}
                    </div>
                    ${currentRole === 'admin' ? `
                        <div class="line-buttons">
                            <button type="button" onclick="updateLineTime(${config.id})">Update</button>
                            <button type="button" onclick="removeLineConfig(${config.id})">Remove</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function updateLineName(lineId, name) {
            const config = lineConfigs.find(c => c.id === lineId);
            if (config) {
                config.name = name;
                saveState();
            }
        }

        function updateLineTime(lineId) {
            const config = lineConfigs.find(c => c.id === lineId);
            if (config) {
                const timeSelect = document.getElementById(`time${lineId}`);
                scheduledTimes[lineId] = parseTime(timeSelect.value);
                config.time = timeSelect.value;
                updateTimers();
                saveState();
            }
        }

        function pad(n) { return n.toString().padStart(2, '0'); }

        function formatTime(date) {
            return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function generateTimeOptions() {
            const now = new Date();
            const startTime = new Date(now);
            startTime.setMinutes(Math.ceil(startTime.getMinutes() / 5) * 5);
            startTime.setSeconds(0);
            startTime.setMilliseconds(0);

            const endTime = new Date(now.getTime() + 2 * 60 * 60000);
            const options = [];

            while (startTime <= endTime) {
                options.push(formatTime(startTime));
                startTime.setMinutes(startTime.getMinutes() + 5);
            }

            return options;
        }

        function parseTime(hm) {
            const [h, m] = hm.split(':').map(Number);
            const d = new Date();
            d.setHours(h, m, 0, 0);
            return d.getTime();
        }

        document.getElementById('scheduleForm').addEventListener('submit', function (e) {
            e.preventDefault();
            updateTimingSettings();
            scheduledTimes = {};

            lineConfigs.forEach(config => {
                const timeSelect = document.getElementById(`time${config.id}`);
                scheduledTimes[config.id] = parseTime(timeSelect.value);
                config.time = timeSelect.value;
            });

            updateTimers();
            toggleConfig();
            saveState();
        });

        function showChangeSeatNotification() {
            const notification = document.getElementById('changeSeatNotification');
            const overlay = document.getElementById('notificationOverlay');

            // Show the notification and overlay first
            notification.style.display = 'block';
            overlay.style.display = 'block';

            // Only try to play sound if audio is enabled
            if (audioEnabled) {
                // Reset and play the alarm sound
                bell.currentTime = 0;

                // Try to play the sound
                const playPromise = bell.play();

                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('Alarm sound started playing');
                        // When the alarm finishes playing, hide the notification
                        bell.addEventListener('ended', () => {
                            console.log('Alarm sound finished playing');
                            notification.style.display = 'none';
                            overlay.style.display = 'none';
                        }, { once: true });
                    }).catch(error => {
                        console.error('Error playing alarm:', error);
                        // If there's an error playing the sound, hide the notification after 3 seconds
                        setTimeout(() => {
                            notification.style.display = 'none';
                            overlay.style.display = 'none';
                        }, 3000);
                    });
                }
            } else {
                // If audio is not enabled, just show the notification for 3 seconds
                console.log('Audio not enabled yet, showing notification without sound');
                setTimeout(() => {
                    notification.style.display = 'none';
                    overlay.style.display = 'none';
                }, 3000);
            }
        }

        function updateTimers() {
            document.getElementById('timers-container').innerHTML = lineConfigs.map(config => `
                <div class="timer-container" data-line="${config.id}">
                    <div class="timer" data-line="${config.id}">
                        <div class="label">${config.name}</div>
                        <div class="count">00:00</div>
                    </div>
                    <div class="people-panel">
                        <div class="title">People in Line</div>
                        <div class="seats-info">
                            ${config.people ? config.people.length : 0}/${MAX_PEOPLE_PER_LINE} seats
                        </div>
                        <div class="people-list">
                            ${config.people && config.people.length > 0
                    ? config.people.map(person => `
                                    <div class="person-entry">
                                        <span>${person.name}</span>
                                    </div>
                                `).join('')
                    : '<div class="empty-message">No one here yet</div>'
                }
                        </div>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.timer').forEach(timer => {
                const line = timer.dataset.line;
                let lastBellTime = null;
                const label = timer.querySelector('.label');
                const countElement = timer.querySelector('.count');
                const timerContainer = timer.closest('.timer-container');

                function update() {
                    if (!scheduledTimes[line]) return;

                    const now = Date.now();
                    const startT = scheduledTimes[line];
                    let remaining, status;

                    if (now < startT) {
                        const timeUntilStart = startT - now;
                        const minutesUntilStart = Math.ceil(timeUntilStart / 60000);
                        countElement.innerHTML = `Starting in ${minutesUntilStart} min<br><span class="scheduled-time">${formatTime(new Date(startT))}</span>`;
                        countElement.classList.add('starting-text');
                        timer.classList.remove('finish-window');

                        // Add blinking effect if within blink time
                        if (timeUntilStart <= BLINK_TIME_MIN * 60000) {
                            timer.classList.add('blinking');
                        } else {
                            timer.classList.remove('blinking');
                        }

                        status = 'inactive';
                    } else {
                        countElement.classList.remove('starting-text');
                        timer.classList.remove('blinking');
                        const elapsed = now - startT;

                        if (elapsed >= TOTAL_SESSION_TIME) {
                            countElement.textContent = "00:00";
                            timer.classList.remove('finish-window');
                            status = 'inactive';

                            // Clear people when time is over
                            const config = lineConfigs.find(c => c.id === parseInt(line));
                            if (config) {
                                config.people = [];
                                saveState();
                                // Update the entire timer container
                                const configIndex = lineConfigs.findIndex(c => c.id === parseInt(line));
                                if (configIndex !== -1) {
                                    const newTimerContainer = document.createElement('div');
                                    newTimerContainer.innerHTML = `
                                        <div class="timer-container" data-line="${config.id}">
                                            <div class="timer" data-line="${config.id}">
                                                <div class="label">${config.name}</div>
                                                <div class="count">00:00</div>
                                            </div>
                                            <div class="people-panel">
                                                <div class="title">People in Line</div>
                                                <div class="seats-info">
                                                    0/${MAX_PEOPLE_PER_LINE} seats
                                                </div>
                                                <div class="people-list">
                                                    <div class="empty-message">No one here yet</div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    timerContainer.replaceWith(newTimerContainer.firstElementChild);
                                }
                            }
                        } else {
                            remaining = TOTAL_SESSION_TIME - elapsed;
                            const mm = Math.floor(remaining / 60000);
                            const ss = Math.floor((remaining % 60000) / 1000);
                            // Check finish window
                            if (remaining <= FINISH_WINDOW_MIN * 60000) {
                                countElement.textContent = "Go to the lobby";
                                countElement.classList.add('lounge-text');
                                timer.classList.add('finish-window');
                            } else {
                                countElement.textContent = `${pad(mm)}:${pad(ss)}`;
                                countElement.classList.remove('lounge-text');
                                timer.classList.remove('finish-window');
                            }
                            status = 'active';

                            // Only trigger alarm if the timer is actually running and we've passed an interval
                            if (status === 'active') {
                                const currentInterval = Math.floor(elapsed / MS5);
                                if (lastBellTime === null) {
                                    lastBellTime = currentInterval;
                                } else if (currentInterval > lastBellTime) {
                                    // Only play alarm if we're not in the middle of updating UI or settings
                                    if (!isUpdatingUI && !window.isUpdatingSettings) {
                                        showChangeSeatNotification();
                                    }
                                    lastBellTime = currentInterval;
                                }
                            }
                        }
                    }
                    timer.classList.toggle('active', status === 'active');
                    timer.classList.toggle('inactive', status === 'inactive');
                }
                setInterval(update, 200);
                update();
            });
        }

        function addPerson(lineId) {
            if (currentRole === 'viewer') return;

            isUpdatingUI = true;  // Set flag before UI update
            const config = lineConfigs.find(c => c.id === lineId);
            if (!config) return;

            const input = document.getElementById(`newPerson${lineId}`);
            const name = input.value.trim();

            if (name && (!config.people || config.people.length < MAX_PEOPLE_PER_LINE)) {
                if (!config.people) config.people = [];
                config.people.push({
                    id: Date.now(),
                    name: name
                });
                input.value = '';
                updateLineConfigs();
                updateTimers();
                saveState();
            }

            // Reset flag after a short delay
            setTimeout(() => {
                isUpdatingUI = false;
            }, 1000);
        }

        function removePerson(lineId, personId) {
            if (currentRole === 'viewer') return;

            isUpdatingUI = true;  // Set flag before UI update
            const config = lineConfigs.find(c => c.id === lineId);
            if (!config || !config.people) return;

            config.people = config.people.filter(p => p.id !== personId);
            updateLineConfigs();
            updateTimers();
            saveState();

            // Reset flag after a short delay
            setTimeout(() => {
                isUpdatingUI = false;
            }, 1000);
        }

        function handlePersonInput(event, lineId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addPerson(lineId);
            }
        }

        // Add event listeners for global settings
        document.getElementById('sessionDuration').addEventListener('change', function () {
            updateTimingSettings();
            updateTimers();
        });

        document.getElementById('alarmInterval').addEventListener('change', function () {
            updateTimingSettings();
            updateTimers();
        });

        document.getElementById('finishWindow').addEventListener('change', function () {
            FINISH_WINDOW_MIN = parseInt(this.value);
            saveState();
            updateTimers();
        });

        document.getElementById('maxPeople').addEventListener('change', function () {
            MAX_PEOPLE_PER_LINE = parseInt(this.value);
            saveState();
            updateLineConfigs();
            updateTimers();
        });

        document.getElementById('blinkTime').addEventListener('change', function () {
            BLINK_TIME_MIN = parseInt(this.value);
            saveState();
            updateTimers();
        });

        // Function to update UI based on role
        function updateUIBasedOnRole() {
            isUpdatingUI = true;  // Set flag before UI update
            currentRole = document.getElementById('userRole').value;
            const configSection = document.querySelector('.config-section');
            const configContent = document.getElementById('configContent');
            const globalSettings = document.querySelector('.global-settings');
            const addLineBtn = document.querySelector('.add-line-btn');
            const formButtons = document.querySelector('.form-buttons');
            const resetBtn = document.querySelector('.reset-btn');

            // Hide all config elements for viewer
            if (currentRole === 'viewer') {
                configSection.style.display = 'none';
            } else {
                // Show config section for admin and dispatcher
                configSection.style.display = 'block';

                // Show/hide elements based on role
                if (currentRole === 'admin') {
                    // Admin can see everything
                    globalSettings.style.display = 'block';
                    addLineBtn.style.display = 'block';
                    formButtons.style.display = 'block';
                    resetBtn.style.display = 'block';

                    // Enable all inputs and buttons except role selector
                    document.querySelectorAll('input, select, button').forEach(element => {
                        if (!element.closest('.role-selector')) {
                            element.disabled = false;
                        }
                    });
                } else if (currentRole === 'dispatcher') {
                    // Dispatcher can only see people management
                    globalSettings.style.display = 'none';
                    addLineBtn.style.display = 'none';
                    formButtons.style.display = 'none';
                    resetBtn.style.display = 'none';

                    // Disable all inputs and buttons except for people management and role selector
                    document.querySelectorAll('input, select, button').forEach(element => {
                        if (element.closest('.people-management') || element.closest('.role-selector')) {
                            element.disabled = false;
                        } else {
                            element.disabled = true;
                        }
                    });
                }
            }

            // Update line configs to reflect new permissions
            updateLineConfigs();

            // Save the state after updating the role
            saveState();

            // Reset flag after a short delay to ensure all updates are complete
            setTimeout(() => {
                isUpdatingUI = false;
            }, 1000);
        }

        // Load saved state when page loads
        loadSavedState();
        // Initialize UI based on role
        updateUIBasedOnRole();

        // Password protection
        const PASSWORD = 'speedchat2025';
        const PASSWORD_STORAGE_KEY = 'speedchat_password_verified';

        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            const modal = document.getElementById('passwordModal');

            if (input.value === PASSWORD) {
                localStorage.setItem(PASSWORD_STORAGE_KEY, 'true');
                modal.classList.remove('visible');
                document.body.style.overflow = 'auto';
            } else {
                error.style.display = 'block';
                input.value = '';
            }
        }

        // Check password on page load
        window.addEventListener('load', function () {
            const isVerified = localStorage.getItem(PASSWORD_STORAGE_KEY) === 'true';
            if (!isVerified) {
                const modal = document.getElementById('passwordModal');
                modal.classList.add('visible');
                document.body.style.overflow = 'hidden';
            }
        });

        // Allow Enter key to submit password
        document.getElementById('passwordInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // Add updateTimingSettings function
        function updateTimingSettings() {
            const sessionMinutes = parseInt(document.getElementById('sessionDuration').value);
            const alarmMinutes = parseInt(document.getElementById('alarmInterval').value);
            BLINK_TIME_MIN = parseInt(document.getElementById('blinkTime').value);
            FINISH_WINDOW_MIN = parseInt(document.getElementById('finishWindow').value);

            TOTAL_SESSION_TIME = sessionMinutes * 60 * 1000;
            MS5 = alarmMinutes * 60 * 1000;
            saveState();
        }

        // Add a helper function to safely add a line
        function addLine(name, people = []) {
            const lineId = lineConfigs.length + 1;
            const lineConfig = {
                id: lineId,
                name: name || `Line ${lineId}`,
                time: '',
                people: people || []
            };
            lineConfigs.push(lineConfig);
            updateLineConfigs();
        }

        // Add saveState function
        async function saveState() {
            const state = {
                config: {
                    sessionDuration: document.getElementById("sessionDuration")?.value || "30",
                    alarmInterval: document.getElementById("alarmInterval")?.value || "5",
                    maxPeoplePerLine: document.getElementById("maxPeoplePerLine")?.value || "4",
                    blinkBeforeStart: document.getElementById("blinkBeforeStart")?.checked || false,
                    blinkTime: document.getElementById("blinkTime")?.value || "5",
                    finishWindow: document.getElementById("finishWindow")?.value || "5",
                    lines: Array.from(document.querySelectorAll(".line-config")).map(line => ({
                        name: line.querySelector(".line-name")?.value || "",
                        time: line.querySelector(`select[id^="time"]`)?.value || "",
                        people: Array.from(line.querySelectorAll(".person-entry")).map(person => ({
                            id: Date.now() + Math.random(), // Generate unique ID
                            name: person.querySelector("span")?.textContent || ""
                        }))
                    }))
                }
            };

            try {
                const response = await fetch("http://localhost:5001/state", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(state),
                });
                if (!response.ok) {
                    throw new Error("Failed to save state");
                }
            } catch (error) {
                console.error("Error saving state:", error);
            }
        }
    </script>
</body>

</html>